
{% extends "ab_tool/base_lti.html" %}
{% load static %}

{% block stylesheet %}
{{ block.super }}
{% endblock %}

{% block content %}
<div ng-app="ABToolExperiment" ng-controller="experimentController">

<div class="container">
    <header>
        <div class="row lti-header">
            {% if create %}
                <h1>
                    <!--a href="{% url 'ab_testing_tool_create_experiment' %}"-->
                    A/B Testing<!--/a-->
                </h1>
            {% else %}
                <h1><!--a href="{% url 'ab_testing_tool_edit_experiment' experiment.id %}"-->
                    Edit Experiment "{{experiment.name}}"<!--/a-->
                </h1>
            {% endif %}
            {% if create %}
                <h2>
                    <a href="{% url 'ab_testing_tool_index' %}">
                        All Experiments
                    </a>
                    <i class="fa fa-chevron-right"></i> 
                    <span>New Experiment</span>
                </h2>
            {% else %}
                <h2>
                    <a href="{% url 'ab_testing_tool_index' %}">
                        All Experiments
                    </a>
                    <i class="fa fa-chevron-right"></i> 
                    <span>Editing Experiment {{experiment.name}}</span>
                </h2>
            {% endif %}
        </div>
    </header>
    <main>
        <p>Pellentesque mattis sit amet felis elementum vulputate. Pellentesque ac ipsum volutpat, ornare dolor quis, interdum ex. Cras consectetur mattis sapien, non fringilla eros convallis pretium. Vivamus volutpat neque sed leo porta auctor. Read our documentation wiki for more detail info.</p>
            
        <form role="form">
            <fieldset>
                <div class="form-group">
                    <legend class="sr-only">Name of experiment</legend>
                    <label for="experimentName">Name:</label> <i class="fa fa-asterisk"></i>
                    <input type="text" class="block form-control" name="experimentName" id="experimentName" ng-model="experiment.name" placeholder="Enter experiment name">
                </div>
                <div class="form-group-description">
                    <p>A descriptive name for this experiment. This will help you organize your experiments</p>
                </div>
            </fieldset>

            <fieldset>
                <div class="form-group">
                    <legend class="sr-only">Students "grouping/segmentation"</legend>
                    <label>Experiment Structure:</label> <i class="fa fa-asterisk"></i>
                    <ul id="expWeights" class="list-withfloats">
                        <li>
                            <a href="#" class="btn btn-icon-only ip-btn-delete disabled">
                                <i class="fa fa-trash"></i><span>Delete</span>
                            </a>
                            <input type="text" name="exp-track-1" id="exp-track-1" placeholder="0" maxlength="3" class="input-group-right float-left">
                            <span> % </span>
                            <a href="#" class="btn btn-link">Track 1</a>
                        </li>
                        <li>
                            
                            <input type="text" name="exp-track-1" id="exp-track-newWeight" placeholder="0" maxlength="3" class="input-group-right float-left">
                            <span> % </span>
                            <input type="text" name="exp-track-1" id="exp-track-newName" placeholder="Enter track name" class="input-newTrackName form-control float-left">
                            <a href="#" class="btn btn-submit"><i class="fa fa-plus"></i> Add Track</a>
                        </li>
                    </ul>

                    <input type="checkbox" name="makeUniform" id="makeUniform"> 
                    <label for="makeUniform">Choose to make uniform</label>
                </div>
                <div class="form-group-description">
                    <p>A descriptive name for this experiment. This will help you organize your experiments</p>
                </div>
            </fieldset>

            <!--div class="form-group col-md-8">
                <label for="experimentName">Name:</label>
                <input type="text" name="experimentName" id="experimentName"
                    class="form-control" ng-model="experiment.name" placeholder="Experiment Name">
            </div-->
            
            <div class="form-group col-md-8" id="expStructure">
                <label>Experiment structure</label><br>
                <ul id="expWeights" class="list-unstyled">
                    <!-- Angular loop over tracks -->
                        <li ng-cloak class="expTrack" ng-repeat="track in experiment.tracks">
                            {% if not started %}
                                <a data-track="delete" ng-show="experiment.tracks.length > 2"
                                    ng-cloak ng-click="deleteTrack(track)">X</a>
                            {% endif %}
                            <!-- Show different weighting if uniformRandom is set -->
                            <label ng-hide="experiment.uniformRandom">
                                <input type="number" min="0" max="100" step="1"
                                    data-track="value" data-trackindex="1"
                                    maxlength="2" size="2"
                                    ng-pattern="/^\d+$/" ng-model="track.weighting"
                                    {%if started %}disabled="disabled"{% endif %}> %
                            </label>
                            <label ng-show="experiment.uniformRandom">
                                <input type="text" disabled="disabled" size="2"
                                    {% verbatim %}ng-cloak value="{{uniformPercent()}}">%{% endverbatim %}
                            </label>
                            <label class="control-label">
                                {% verbatim %}
                                    <span data-track="name" title="Edit track name" ng-cloak>
                                        Track "{{track.name}}"
                                    </span>
                                {% endverbatim %}
                            </label>
                        </li>
                    <!-- End Angular loop over tracks -->
                </ul>
            </div>
            
            {% if not started %}
                <div class="form-group col-md-8">
                    <!-- Hide weighting if uniformRandom is set -->
                    <label ng-hide="experiment.uniformRandom">
                        <input type="number" min="0" max="100" step="1"
                                data-track="value" data-trackindex="1"
                                maxlength="2" size="2" placeholder="0"
                                ng-pattern="/^\d+$/" ng-model="newTrackWeighting"> %
                    </label>
                    <input type="text" name="newTrackName" id="newTrackName" placeholder="Enter track name" ng-model="newTrackName">
                    <a ng-click="addTrack()" class="btn btn-default btn-xs" id="addTrack">Add Track</a>
                </div>
            {% endif %}
            
            <div class="panel panel-default col-md-8">
                <div class="panel-body">
                    <label>
                        <input type="checkbox" name="uniformRandom"
                            ng-model="experiment.uniformRandom"
                            {%if started %}disabled="disabled"{% endif %}>
                        Give each track equal weighting (uniform random)
                    </label>
                </div>
            </div>
            
            <!-- Disabled until project phase 2
                <div class="form-group col-md-8">
                    <label class="control-label">Sort type:</label>
                    <ul class="list-unstyled">
                        <li><input type="radio" name="sort" value="sortAt_start" checked> Sort upon student's course registration</li>
                        <li><input type="radio" name="sort" value="sortAt_tool"> Sort upon student encountering first intervention</li>
                    </ul>
                </div>
            -->
            
            <div class="form-group col-md-8">
                <label class="control-label" for="experimentNotes">Notes</label>
                <textarea name="experimentNotes" id="experimentNotes" placeholder="Additional notes about experiment..." class="form-control" ng-model="experiment.notes"></textarea>
            </div>
            
            <div class="form-group col-md-8">
                <a id="update-cancel" ng-click="cancel()">Cancel</a>
                {% if create %}
                    <button class="btn btn-primary" id="create-confirm" data-toggle="modal" data-target="#confirmSubmit">Create</button>
                {% else %}
                    <button class="btn btn-primary" id="update-confirm" data-toggle="modal" data-target="#confirmSubmit">Update</button>
                {% endif %}
            </div>
        </form>
        
    </main>
</div>

<!-- create confirmation (start) -->

<div class="modal fade" id="confirmSubmit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        {% if create %}
            <h4 class="modal-title">Create Summary</h4>
        {% else %}
            <h4 class="modal-title">Edit Summary</h4>
        {% endif %}
      </div>
      <div class="modal-body">
        <p>Review your experiment set up and choose if you want to be sort at start or at tool</p>
        <h4>Details:</h4>
        {% verbatim %}
        <dl id="expSummary" class="dl-horizontal">
            <dt>Name:</dt><dd>{{experiment.name}}</dd>
            <!-- Angular loop over tracks -->
                <div ng-repeat="track in experiment.tracks">
                    <dt ng-cloak>Track "{{track.name}}":</dt>
                        <!-- Show different weighting if uniformRandom is set -->
                        <dd ng-cloak ng-hide="experiment.uniformRandom">{{track.weighting}}%</dd>
                        <dd ng-cloak ng-show="experiment.uniformRandom">{{uniformPercent()}}%</dd>
                </div>
            <!-- End Angular loop over tracks -->
            <dt>Notes:</dt><dd>{{experiment.notes}}</dd>
        </dl>
        {% endverbatim %}
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        {% if create %}
            <button type="button" id="createNow" class="btn btn-primary" ng-click="submit()">Submit Create</button>
        {% else %}
            <button type="button" id="createNow" class="btn btn-primary" ng-click="submit()">Submit Update</button>
        {% endif %}
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- create confirmation (end) -->

</div> <!-- end angular app -->
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript">
    {% if create %}
        window.initialExperiment = {"name": "", "notes": "", "uniformRandom": true,
            "tracks": [{"id": null, "name": "A"}, {"id": null, "name": "B"}]};
        window.modifiedExperiment = JSON.parse(JSON.stringify(window.initialExperiment));
        
        window.submitURL = "{% url 'ab_testing_tool_submit_create_experiment' %}";
    {% else %}
        window.initialExperiment = JSON.parse("{{ experiment.to_json | escapejs}}");
        window.modifiedExperiment = JSON.parse("{{ experiment.to_json | escapejs}}");
        
        window.submitURL = "{% url 'ab_testing_tool_submit_edit_experiment' experiment.id %}";
    {% endif %}
    
    window.parentPage = "{% url 'ab_testing_tool_index' %}";
</script>

<script src="{% static "ab_tool/js/angular-1.2.27.min.js" %}"></script>
<script src="{% static "ab_tool/js/experiment.js" %}"></script>

{% endblock %}
